

<!DOCTYPE html>
<html class="writer-html5" lang="ko" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>OT_UdpCapture 메인 소스 &mdash; OT_UdpCapture 1.1.0 문서</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/translations.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="색인" href="genindex.html" />
    <link rel="search" title="검색" href="search.html" />
    <link rel="prev" title="OT_UdpCapture1.1.0 문서(21.03.22)" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> OT_UdpCapture
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">OT_UdpCapture 메인 소스</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">소스코드</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#id2">참고 함수</a></li>
<li class="toctree-l1"><a class="reference internal" href="#id3">총 코드</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">OT_UdpCapture</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>OT_UdpCapture 메인 소스</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/OT_UdpCapture.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="ot-udpcapture">
<h1>OT_UdpCapture 메인 소스<a class="headerlink" href="#ot-udpcapture" title="제목 주소">¶</a></h1>
<div class="section" id="id1">
<h2>소스코드<a class="headerlink" href="#id1" title="제목 주소">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">pcap</span>
<span class="kn">import</span> <span class="nn">dpkt</span>
<span class="kn">import</span> <span class="nn">OT_ShmLib</span> <span class="k">as</span> <span class="nn">ot</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">sys</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">-*-</span> <span class="pre">coding:</span> <span class="pre">utf-8</span> <span class="pre">-*-</span></code> 리눅스일 경우</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">OT_ShmLib</span> <span class="pre">as</span> <span class="pre">ot</span></code> 공유메모리</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">OT_UdpCapture</span><span class="p">:</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">pass</span>
   <span class="k">def</span> <span class="nf">capture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="n">nId</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">nOffset</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">nSize</span> <span class="o">=</span> <span class="mi">2000</span>
      <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_byte</span><span class="o">*</span><span class="n">nSize</span><span class="p">)()</span>
      <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
      <span class="n">filetime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H_%M_%S&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">nId</span></code> 은 공유메모리 소스코드의 변수이며 한 덩어리를 의미(한덩어리=Shm_COL_SIZE(2000byte)*SHM_ROW_SIZE(100)) 총 3개의 nID</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nOffset</span></code> 은 공유메모리 소스코드 변수이며 한 덩어리 안에서 얼마나 떨어져 있는가를 의미</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nSize</span></code> 은 은 공유메모리 소스코드 변수이며 패킷 한덩어리(=Shm_COL_SIZE)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">capture(self):</span></code> 은 캡쳐와 pcap파일로 저장하는 함수</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">start=time.time()</span></code> 프로그램 시작시간</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">filetime</span></code> 은 파일이름 저장시 파일이름이 되는 24시간 기준 시_분_초</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#..</span>
      <span class="n">sniffer</span> <span class="o">=</span> <span class="n">pcap</span><span class="o">.</span><span class="n">pcap</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">promisc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">immediate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">name=None</span></code> 디바이스 이름 None을 두면 디폴트 값이 들어가게 되고 작은 따옴표 안에 직접 디바이스 명을 넣을수 있음</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">promisc=True</span></code> 프리큐어스모드(무차별) True는 모든 패킷을 캡쳐 가능</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">immediate=True</span></code> immediate 옵션 해당 옵션을 True로 설정하여 지연문제를 없앨수 있음</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">timeout_ms=50</span></code> 타임아웃시간 ms단위로 50이면 0.05초로 설정</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#.</span>
     <span class="n">sniffer</span><span class="o">.</span><span class="n">setfilter</span><span class="p">(</span><span class="s1">&#39;udp and port 5353&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>현재 상태: UDP 필터 포트5353필터(쓰지 않아도 됨)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#..</span>
      <span class="n">n</span><span class="o">=</span><span class="mi">0</span>
      <span class="n">writer</span> <span class="o">=</span> <span class="n">dpkt</span><span class="o">.</span><span class="n">pcap</span><span class="o">.</span><span class="n">Writer</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">filetime</span><span class="o">+</span><span class="s2">&quot;.pcap&quot;</span><span class="p">,</span> <span class="s1">&#39;wb+&#39;</span><span class="p">))</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">n</span></code> 은 패킷을 셀 수 있는 변수</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">writer</span></code> 은 dpkt를 이용하여 pcap파일을 작성함</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#..</span>
      <span class="k">for</span> <span class="n">ts</span><span class="p">,</span> <span class="n">pkt</span> <span class="ow">in</span> <span class="n">sniffer</span><span class="p">:</span>
         <span class="n">writer</span><span class="o">.</span><span class="n">writepkt</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
         <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sniffer</span></code> 객체의 첫번 째 값은 <code class="docutils literal notranslate"><span class="pre">timestamp**</span> <span class="pre">,</span> <span class="pre">두번째값은</span>&#160; <span class="pre">``packet</span></code> 으로 반복문을 돌겠다는 의미</p></li>
<li><p>이후 pkt[idx] 형식으로 네트워크 패킷의 특정 위치 인덱스 값을 가져올 수 있음</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">writer.writepkt(pkt,</span> <span class="pre">ts)</span></code> pcap파일에 저장</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">n</span></code> 은 패킷을 카운트하는 변수이며 <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">ts,</span> <span class="pre">pkt</span> <span class="pre">in</span> <span class="pre">sniffer:</span></code> 하위에</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#..</span>
          <span class="sd">&quot;&quot;&quot;print(&#39;Dst MAC - &#39;, end=&#39;&#39;, flush=True) #프레임을 수신할 맥주소정보-이더넷 헤더</span>
<span class="sd">         print(&#39;:&#39;.join(&#39;%02X&#39; % i for i in pkt[0:6])) #패킷의 0번부터 5번 바이트까지 출력 (Str(hex))</span>
<span class="sd">         print(&#39;Src MAC - &#39;, end=&#39;&#39;, flush=True)#프레임을 송신할 호스트의 맥주소 정보-이더넷헤더</span>
<span class="sd">         print(&#39;:&#39;.join(&#39;%02X&#39; % i for i in pkt[6:12])) #패킷의 6번부터 11번 바이트까지 출력</span>
<span class="sd">         print(&#39;:&#39;.join(&#39;%02X&#39; % i for i in pkt[:]))</span>
<span class="sd">         print(str(pkt))&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>등 을 이용할 수 있음</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#..</span>
         <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%02x</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">42</span><span class="p">:</span><span class="mi">43</span><span class="p">]))</span> <span class="o">==</span> <span class="s2">&quot;32&quot;</span><span class="p">:</span>
             <span class="k">if</span> <span class="n">nOffset</span> <span class="o">&lt;</span> <span class="mi">200000</span><span class="p">:</span>
               <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nId&quot;</span><span class="p">,</span> <span class="n">nId</span><span class="p">,</span> <span class="s2">&quot;nOffset&quot;</span><span class="p">,</span> <span class="n">nOffset</span><span class="p">)</span>
               <span class="n">testVal</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%02x</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pkt</span><span class="p">[:])</span>
               <span class="n">testVal</span><span class="o">=</span><span class="n">testVal</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
               <span class="nb">print</span><span class="p">(</span><span class="n">testVal</span><span class="p">)</span>
               <span class="n">struct</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span><span class="s1">&#39;2000s&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">testVal</span><span class="p">)</span>
               <span class="n">shm</span><span class="o">.</span><span class="n">WriteShm</span><span class="p">(</span><span class="n">nId</span><span class="p">,</span> <span class="n">byref</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">nOffset</span><span class="p">,</span> <span class="n">nSize</span><span class="p">)</span>
               <span class="n">nOffset</span> <span class="o">=</span> <span class="n">nOffset</span><span class="o">+</span><span class="mi">2000</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">(''.join('%02x'</span> <span class="pre">%</span> <span class="pre">i</span> <span class="pre">for</span> <span class="pre">i</span> <span class="pre">in</span> <span class="pre">pkt[42:43]))==&quot;32&quot;:</span></code> 42번자리 str(hex) 값이 32 즉 아스키코드로 변환시 2일경우 공유메모리에 저장하는 조건</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">nOffset</span> <span class="pre">&lt;</span> <span class="pre">200000:</span></code> 한덩어리=Shm_COL_SIZE(2000byte)*SHM_ROW_SIZE(100) 기준으로 저장</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">testVal=''.join('%02x'</span> <span class="pre">%</span> <span class="pre">i</span> <span class="pre">for</span> <span class="pre">i</span> <span class="pre">in</span> <span class="pre">pkt[:])</span></code> 공유메모리에 저장할 변수는 str(hex) 형태</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">testVal=testVal.encode()</span></code> byte형태로 변환</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">struct.pack_into</span></code> struck(패킹된 바이너리 데이터로 바이트열을 해설하는 표준 라이브러리) 함수로  <code class="docutils literal notranslate"><span class="pre">struct.pack_into(format,</span> <span class="pre">buffer,</span> <span class="pre">offset,</span> <span class="pre">v1,</span> <span class="pre">v2,</span> <span class="pre">...)</span></code> 포맷 문자열 format에 따라 값 v1, v2, … 를 패킹하고 패킹 된 바이트열을 쓰기 가능한 버퍼 buffer에 offset 위치에서부터 사용</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">shm.WriteShm(nId,</span> <span class="pre">byref(data),</span> <span class="pre">nOffset,</span> <span class="pre">nSize)</span></code> OT_ShmLib 공유메로리 함수로써 메모리를 쓰는 함수</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nOffset</span> <span class="pre">=</span> <span class="pre">nOffset+2000</span></code> 2000byte 기준으로 공유메로리를 작성</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#..</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nId</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">:</span>
               <span class="n">nId</span> <span class="o">=</span> <span class="n">nId</span><span class="o">+</span><span class="mi">1</span>
               <span class="n">nOffset</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">nId</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
<ul class="simple">
<li><p>공유메모리 함수 기준으로 차례로 공유메모리로 작성</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#..</span>
         <span class="k">if</span> <span class="n">n</span><span class="o">==</span><span class="mi">1000</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;completion&quot;</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">break</span>
</pre></div>
</div>
<p>패킷이 1000번이카운터가 되면 파일은 닫히며 무한루프도 종료</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
   <span class="n">shm</span><span class="o">=</span><span class="n">ot</span><span class="o">.</span><span class="n">OT_ShmLib</span><span class="p">()</span>
   <span class="n">shm</span><span class="o">.</span><span class="n">CreateShm</span><span class="p">()</span>
   <span class="n">udp</span><span class="o">=</span><span class="n">OT_UdpCapture</span><span class="p">()</span>
   <span class="n">udp</span><span class="o">.</span><span class="n">capture</span><span class="p">()</span>
   <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;time :&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">shm.CreateShm()</span></code> 공유메모리를 작성하기전 만드는 함수</p></li>
<li><p>print는 클래스 함수를 사용하며 종료되는 시간과 처음시간과 차이로 프로그램 시간을 구함</p></li>
</ul>
</div>
</div>
<div class="section" id="id2">
<h1>참고 함수<a class="headerlink" href="#id2" title="제목 주소">¶</a></h1>
<p><strong>pcap파일을 저장해서 txt파일로 변환 txt파일을 josn파일로 변환하는 함수</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">dpkt</span>
<span class="k">def</span> <span class="nf">json_format</span><span class="p">():</span>
   <span class="n">json_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filetime</span><span class="o">+</span><span class="s2">&quot;.txt&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
   <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filetime</span><span class="o">+</span><span class="s2">&quot;.pcap&quot;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
      <span class="n">pcap</span> <span class="o">=</span> <span class="n">dpkt</span><span class="o">.</span><span class="n">pcap</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">ts</span><span class="p">,</span> <span class="n">buf</span> <span class="ow">in</span> <span class="n">pcap</span><span class="p">:</span>
         <span class="n">json_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filetime</span><span class="o">+</span><span class="s2">&quot;.txt&quot;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
         <span class="n">eth</span> <span class="o">=</span> <span class="n">dpkt</span><span class="o">.</span><span class="n">ethernet</span><span class="o">.</span><span class="n">Ethernet</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
         <span class="n">buf</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%02X</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">buf</span><span class="p">[:])</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="n">eth</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
         <span class="nb">print</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
         <span class="n">json_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
         <span class="n">json_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
   <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filetime</span><span class="o">+</span><span class="s2">&quot;.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
   <span class="n">strings</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
   <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filetime</span><span class="o">+</span><span class="s2">&quot;.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
   <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">strings</span><span class="p">,</span> <span class="n">json_file</span><span class="p">)</span>
</pre></div>
</div>
<p>pcap -&gt; txt -&gt; json 변환</p>
</div>
<div class="section" id="id3">
<h1>총 코드<a class="headerlink" href="#id3" title="제목 주소">¶</a></h1>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">pcap</span>
<span class="kn">import</span> <span class="nn">dpkt</span>
<span class="kn">import</span> <span class="nn">OT_ShmLib</span> <span class="k">as</span> <span class="nn">ot</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">class</span> <span class="nc">OT_UdpCapture</span><span class="p">():</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">pass</span>
   <span class="k">def</span> <span class="nf">capture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="n">nId</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">nOffset</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">nSize</span> <span class="o">=</span> <span class="mi">2000</span>
      <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_byte</span><span class="o">*</span><span class="n">nSize</span><span class="p">)()</span>
      <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
      <span class="n">filetime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H_%M_%S&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
      <span class="n">sniffer</span> <span class="o">=</span> <span class="n">pcap</span><span class="o">.</span><span class="n">pcap</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span> <span class="p">,</span><span class="n">promisc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">immediate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="n">sniffer</span><span class="o">.</span><span class="n">setfilter</span><span class="p">(</span><span class="s2">&quot;udp&quot;</span><span class="p">)</span>
      <span class="n">n</span><span class="o">=</span><span class="mi">0</span>
      <span class="n">writer</span> <span class="o">=</span> <span class="n">dpkt</span><span class="o">.</span><span class="n">pcap</span><span class="o">.</span><span class="n">Writer</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">filetime</span><span class="o">+</span><span class="s2">&quot;.pcap&quot;</span><span class="p">,</span> <span class="s1">&#39;wb+&#39;</span><span class="p">))</span>
      <span class="k">for</span> <span class="n">ts</span><span class="p">,</span> <span class="n">pkt</span> <span class="ow">in</span> <span class="n">sniffer</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writepkt</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
            <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%02x</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">42</span><span class="p">:</span><span class="mi">43</span><span class="p">]))</span> <span class="o">==</span> <span class="s2">&quot;32&quot;</span><span class="p">:</span>
               <span class="c1">#print(&quot;----------&quot;)</span>
               <span class="k">if</span> <span class="n">nOffset</span> <span class="o">&lt;</span> <span class="mi">200000</span><span class="p">:</span>
                  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nId&quot;</span><span class="p">,</span> <span class="n">nId</span><span class="p">,</span> <span class="s2">&quot;nOffset&quot;</span><span class="p">,</span> <span class="n">nOffset</span><span class="p">)</span>
                  <span class="n">testVal</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%02x</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pkt</span><span class="p">[:])</span>
                  <span class="n">testVal</span><span class="o">=</span><span class="n">testVal</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
                  <span class="nb">print</span><span class="p">(</span><span class="n">testVal</span><span class="p">)</span>
                  <span class="n">struct</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span><span class="s1">&#39;2000s&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">testVal</span><span class="p">)</span>
                  <span class="n">shm</span><span class="o">.</span><span class="n">WriteShm</span><span class="p">(</span><span class="n">nId</span><span class="p">,</span> <span class="n">byref</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">nOffset</span><span class="p">,</span> <span class="n">nSize</span><span class="p">)</span>
                  <span class="n">nOffset</span> <span class="o">=</span> <span class="n">nOffset</span><span class="o">+</span><span class="mi">2000</span>
               <span class="k">else</span><span class="p">:</span>
                  <span class="k">if</span> <span class="n">nId</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">:</span>
                        <span class="n">nId</span> <span class="o">=</span> <span class="n">nId</span><span class="o">+</span><span class="mi">1</span>
                        <span class="n">nOffset</span><span class="o">=</span><span class="mi">0</span>
                  <span class="k">else</span><span class="p">:</span>
                        <span class="n">nId</span><span class="o">=</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">n</span><span class="o">==</span><span class="mi">100</span><span class="p">:</span>
               <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;completion&quot;</span><span class="p">)</span>
               <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
               <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;time :&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
               <span class="k">break</span>


<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
   <span class="n">shm</span><span class="o">=</span><span class="n">ot</span><span class="o">.</span><span class="n">OT_ShmLib</span><span class="p">()</span>
   <span class="n">shm</span><span class="o">.</span><span class="n">CreateShm</span><span class="p">()</span>
   <span class="n">udp</span><span class="o">=</span><span class="n">OT_UdpCapture</span><span class="p">()</span>
   <span class="n">udp</span><span class="o">.</span><span class="n">capture</span><span class="p">()</span>
</pre></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="index.html" class="btn btn-neutral float-left" title="OT_UdpCapture1.1.0 문서(21.03.22)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, pcs.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>